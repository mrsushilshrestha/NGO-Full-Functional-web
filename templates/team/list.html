{% extends 'base.html' %}
{% load crispy_forms_tags %}

{% block title %}Our Team{% endblock %}

{% block extra_css %}
<link href="https://fonts.googleapis.com/css2?family=DM+Sans:wght@400;700;800&family=Inter:wght@400;600;800&family=Lato:wght@400;700&family=Merriweather:wght@400;700&family=Nunito:wght@400;600;700;800&family=Open+Sans:wght@400;600;700&family=Playfair+Display:wght@400;600;700&family=Poppins:wght@400;600;700;800&family=Plus+Jakarta+Sans:wght@400;600;700;800&family=Roboto:wght@400;500;700&display=swap" rel="stylesheet">
<style>
:root{
    --team-title-size: {{ team_settings.title_font_size_px }}px;
    --team-subtitle-size: {{ team_settings.subtitle_font_size_px }}px;
    --team-card-radius: {{ team_settings.card_radius_px }}px;
    --team-card-min-h: {{ team_settings.card_min_height_px }}px;
    --team-card-max-h: {{ team_settings.card_max_height_px }}px;
    --team-card-padding: {{ team_settings.card_padding_px }}px;
    --team-section-spacing: {{ team_settings.section_spacing_px }}px;
    --team-social-size: {{ team_settings.social_icon_size_px }}px;
    --team-name-size: {{ team_settings.name_font_size_px }}px;
    --team-role-size: {{ team_settings.role_font_size_px }}px;
    --team-id-size: {{ team_settings.id_font_size_px }}px;
}

.team-hero-title {
    font-family: {% if team_settings.title_font_family == 'nunito' %}'Nunito'{% elif team_settings.title_font_family == 'plus_jakarta' %}'Plus Jakarta Sans'{% elif team_settings.title_font_family == 'inter' %}'Inter'{% elif team_settings.title_font_family == 'poppins' %}'Poppins'{% elif team_settings.title_font_family == 'open_sans' %}'Open Sans'{% elif team_settings.title_font_family == 'lato' %}'Lato'{% elif team_settings.title_font_family == 'roboto' %}'Roboto'{% elif team_settings.title_font_family == 'playfair' %}'Playfair Display'{% elif team_settings.title_font_family == 'merriweather' %}'Merriweather'{% else %}'DM Sans'{% endif %}, system-ui, sans-serif;
    font-weight: 800;
    font-size: var(--team-title-size);
    color: {{ team_settings.title_color }};
    letter-spacing: -0.02em;
    line-height: 1.2;
    min-height: 1.3em;
    text-align: {{ team_settings.heading_align }};
}
.team-hero-subtitle {
    font-family: {% if team_settings.subtitle_font_family == 'nunito' %}'Nunito'{% elif team_settings.subtitle_font_family == 'plus_jakarta' %}'Plus Jakarta Sans'{% elif team_settings.subtitle_font_family == 'inter' %}'Inter'{% elif team_settings.subtitle_font_family == 'poppins' %}'Poppins'{% elif team_settings.subtitle_font_family == 'open_sans' %}'Open Sans'{% elif team_settings.subtitle_font_family == 'lato' %}'Lato'{% elif team_settings.subtitle_font_family == 'roboto' %}'Roboto'{% elif team_settings.subtitle_font_family == 'playfair' %}'Playfair Display'{% elif team_settings.subtitle_font_family == 'merriweather' %}'Merriweather'{% else %}'DM Sans'{% endif %}, system-ui, sans-serif;
    font-weight: 400;
    font-size: var(--team-subtitle-size);
    color: {{ team_settings.subtitle_color }};
    line-height: 1.65;
    min-height: 3em;
    text-align: {{ team_settings.heading_align }};
}
.team-hero-title.team-anim-fade { animation: team-title-fade 0.7s ease-out; }
.team-hero-title.team-anim-slide { animation: team-title-slide 0.7s ease-out; }
.team-hero-title.team-anim-zoom { animation: team-title-zoom 0.5s ease-out; }
.team-hero-title.team-anim-bounce { animation: team-title-bounce 0.7s ease; }
@keyframes team-title-fade { from { opacity: 0; } to { opacity: 1; } }
@keyframes team-title-slide { from { opacity: 0; transform: translateY(24px); } to { opacity: 1; transform: translateY(0); } }
@keyframes team-title-zoom { from { opacity: 0; transform: scale(0.92); } to { opacity: 1; transform: scale(1); } }
@keyframes team-title-bounce { 0%, 100% { transform: translateY(0); } 50% { transform: translateY(-10px); } }
.typed-cursor {
    display: inline-block;
    width: 3px;
    height: 1em;
    background: var(--primary);
    margin-left: 2px;
    vertical-align: -0.15em;
    animation: team-blink 0.8s step-end infinite;
}
@keyframes team-blink {
    50% { opacity: 0; }
}
/* Full-width decorative line under category (Board Members / Volunteers) */
.team-category-line {
    margin: 0 0 1.5rem 0;
    border: none;
    border-radius: 999px;
}

/* Watermark background on Team page */
.team-page-wrap { position: relative; }
/* Dark theme for Team page */
.team-page-dark .team-hero-title,
.team-page-dark .team-hero-subtitle { color: #e2e8f0 !important; }
.team-page-dark .section-title,
.team-page-dark .section-subtitle,
.team-page-dark .h4,
.team-page-dark .form-label,
.team-page-dark .text-muted { color: #94a3b8 !important; }
.team-page-dark .team-filters .form-control,
.team-page-dark .team-filters .form-select { background: #334155; border-color: #475569; color: #f1f5f9; }
.team-page-dark .btn-outline-primary { border-color: #64748b; color: #e2e8f0; }
.team-page-dark .btn-outline-primary:hover { background: #475569; border-color: #64748b; color: #fff; }
.team-page-dark .btn-primary { background: #0d9488; border-color: #0d9488; }

/* Location filter tabs – active matches nav (var(--primary)), sliding underline */
.team-location-tabs-wrap { position: relative; margin-bottom: 0; }
.team-location-tabs {
    display: flex;
    flex-wrap: wrap;
    gap: 0.5rem 1.5rem;
    list-style: none;
    margin: 0;
    padding: 0;
    border: none;
    position: relative;
}
.team-location-tab {
    background: none;
    border: none;
    padding: 0.5rem 0 0.75rem;
    font-size: 1rem;
    font-weight: 500;
    color: inherit;
    cursor: pointer;
    position: relative;
    transition: color 0.25s ease;
    opacity: 0.85;
}
.team-page-dark .team-location-tab { color: #94a3b8; }
.team-location-tab:hover { opacity: 1; }
.team-location-tab.active {
    color: var(--primary);
    opacity: 1;
}
.team-page-dark .team-location-tab.active { color: var(--primary); }
.team-location-indicator {
    position: absolute;
    bottom: 0;
    left: 0;
    height: 3px;
    background: var(--primary);
    border-radius: 2px;
    transition: left 0.3s ease, width 0.3s ease;
    pointer-events: none;
    order: 9999;
}
.team-location-tabs-sep {
    margin: 0;
    border: none;
    border-top: 1px solid rgba(0,0,0,0.08);
}
.team-page-dark .team-location-tabs-sep { border-top-color: rgba(255,255,255,0.1); }
.volunteer-cards-transition { transition: opacity 0.25s ease; }
.volunteer-cards-transition.is-loading { opacity: 0.6; pointer-events: none; }

/* Top bar: search icon + Join Us */
.team-top-actions { min-height: 2.5rem; }
.btn-icon.btn-search-toggle {
    width: 2.5rem;
    height: 2.5rem;
    padding: 0;
    display: inline-flex;
    align-items: center;
    justify-content: center;
    background: #fff;
    border: 1px solid rgba(0,0,0,0.08);
    color: var(--primary);
    transition: transform 0.2s ease, box-shadow 0.2s ease;
}
.team-page-dark .btn-icon.btn-search-toggle { background: #334155; border-color: rgba(255,255,255,0.1); color: var(--primary); }
.btn-icon.btn-search-toggle:hover { transform: translateY(-1px); box-shadow: 0 4px 12px rgba(0,0,0,0.08); }
.team-search-wrap { display: inline-flex; align-items: center; }
.team-search-expand {
    display: none;
    align-items: center;
    background: #fff;
    border: 1px solid rgba(0,0,0,0.08);
    padding: 0.25rem 0.75rem 0.25rem 1rem;
    min-width: 200px;
}
.team-search-expand.is-open { display: inline-flex; }
.team-page-dark .team-search-expand { background: #334155; border-color: rgba(255,255,255,0.1); }
.team-search-expand input { background: transparent !important; }
.team-search-close { margin-left: 0.25rem; }
.team-location-tabs-sep { margin-bottom: 1rem; }

@media (max-width: 767px) {
    .team-location-tabs { gap: 0.25rem 1rem; }
    .team-location-tab { font-size: 0.9rem; padding: 0.4rem 0 0.6rem; }
}

.team-watermark {
    position: absolute;
    inset: 0;
    pointer-events: none;
    background-repeat: no-repeat;
    background-position:
        {% if team_settings.watermark_position == 'top-left' %}left top
        {% elif team_settings.watermark_position == 'top-right' %}right top
        {% elif team_settings.watermark_position == 'bottom-left' %}left bottom
        {% elif team_settings.watermark_position == 'bottom-right' %}right bottom
        {% else %}center{% endif %};
    background-size: {{ team_settings.watermark_size_percent }}%;
    opacity: {{ team_settings.watermark_opacity }};
    filter: grayscale(1);
}

/* Team section – card styling from CMS */
.member-card-modern {
    position: relative;
    border-radius: var(--team-card-radius);
    overflow: hidden;
    min-height: var(--team-card-min-h);
    aspect-ratio: 4 / 5;
    max-height: var(--team-card-max-h);
    box-sizing: border-box;
    transition: transform 0.35s ease-in-out, box-shadow 0.35s ease-in-out, box-shadow 0.35s;
    cursor: pointer;
    background: #0a0a0a;
}
/* Card shadow: none / soft / medium / strong */
.team-cards-shadow-none .member-card-modern { box-shadow: none; }
.team-cards-shadow-soft .member-card-modern { box-shadow: 0 4px 16px rgba(0, 0, 0, 0.06); }
.team-cards-shadow-medium .member-card-modern,
.member-card-modern { box-shadow: 0 8px 30px rgba(0, 0, 0, 0.08), 0 2px 10px rgba(0, 0, 0, 0.04); }
.team-cards-shadow-strong .member-card-modern { box-shadow: 0 12px 40px rgba(0, 0, 0, 0.12), 0 4px 16px rgba(0, 0, 0, 0.08); }
.team-cards-hover-lift .member-card-modern:hover,
.member-card-modern:hover { transform: translateY(-8px); box-shadow: 0 18px 48px rgba(0, 0, 0, 0.12), 0 8px 20px rgba(0, 0, 0, 0.06); }
.team-cards-hover-scale .member-card-modern:hover { transform: scale(1.03); box-shadow: 0 18px 48px rgba(0, 0, 0, 0.12); }
.team-cards-hover-glow .member-card-modern:hover { box-shadow: 0 0 32px rgba(11, 83, 69, 0.35), 0 12px 40px rgba(0, 0, 0, 0.1); }
.team-cards-hover-none .member-card-modern:hover { transform: none; box-shadow: inherit; }
/* Card enter animation */
.team-card-anim-fadeIn .member-card-modern { animation: team-card-fadeIn 0.5s ease-out; }
.team-card-anim-slideUp .member-card-modern { animation: team-card-slideUp 0.5s ease-out; }
.team-card-anim-zoomIn .member-card-modern { animation: team-card-zoomIn 0.4s ease-out; }
@keyframes team-card-fadeIn { from { opacity: 0; } to { opacity: 1; } }
@keyframes team-card-slideUp { from { opacity: 0; transform: translateY(24px); } to { opacity: 1; transform: translateY(0); } }
@keyframes team-card-zoomIn { from { opacity: 0; transform: scale(0.95); } to { opacity: 1; transform: scale(1); } }
.member-card-image {
    position: absolute;
    top: 0;
    left: 0;
    width: 100%;
    height: 100%;
    object-fit: cover;
    transition: transform 0.4s ease-in-out;
    z-index: 1;
}
.member-card-modern:hover .member-card-image {
    transform: scale(1.06);
}
/* Soft gradient at bottom for readability */
.member-card-overlay {
    position: absolute;
    top: 0;
    left: 0;
    width: 100%;
    height: 100%;
    background: linear-gradient(to top, rgba(0,0,0,0.88) 0%, rgba(0,0,0,0.5) 40%, rgba(0,0,0,0.2) 65%, transparent 100%);
    z-index: 2;
    pointer-events: none;
}
/* Content block – name, role, ID and social at bottom, aligned together */
.member-card-content {
    position: absolute;
    bottom: 0;
    left: 0;
    right: 0;
    z-index: 3;
    padding: 20px var(--team-card-padding) 6px var(--team-card-padding);
    margin-bottom: 0;
    min-height: 185px;
    display: flex;
    flex-direction: column;
    justify-content: flex-end;
    color: #ffffff !important;
}
.member-card-name {
    font-size: var(--team-name-size);
    font-weight: 700;
    line-height: 1.3;
    margin: 0 0 8px 0;
    text-shadow: 0 2px 12px rgba(0,0,0,0.5);
    color: #ffffff !important;
}
.member-card-role {
    font-size: var(--team-role-size);
    font-weight: 400;
    margin: 0 0 12px 0;
    opacity: 0.92;
    text-transform: uppercase;
    letter-spacing: 0.06em;
    color: #ffffff !important;
}
.member-card-id-wrap {
    margin-bottom: 8px;
}
.member-card-id {
    font-size: var(--team-id-size);
    font-weight: 600;
    background: rgba(255, 255, 255, 0.18);
    color: #ffffff !important;
    padding: 6px 13px;
    border-radius: 20px;
    display: inline-block;
    border: 1px solid rgba(255, 255, 255, 0.24);
}
/* Social icons – aligned with text above, slightly lower for spacing */
.member-card-social {
    display: flex;
    flex-wrap: wrap;
    gap: 8px;
    margin-top: 6px;
    margin-bottom: 0;
    padding-bottom: 2px;
    margin-left: auto;
    justify-content: flex-end;
    opacity: 0;
    transform: translateY(8px);
    transition: opacity 0.3s ease-in-out, transform 0.3s ease-in-out;
}
.member-card-modern:hover .member-card-social {
    opacity: 1;
    transform: translateY(0);
}
.member-social-icon {
    width: var(--team-social-size);
    height: var(--team-social-size);
    min-width: var(--team-social-size);
    min-height: var(--team-social-size);
    display: flex;
    align-items: center;
    justify-content: center;
    background: rgba(255, 255, 255, 0.14);
    border-radius: 50%;
    color: #ffffff !important;
    text-decoration: none;
    border: 1px solid rgba(255, 255, 255, 0.2);
    transition: transform 0.25s ease-in-out, background-color 0.25s ease-in-out, box-shadow 0.25s ease-in-out;
    box-shadow: 0 2px 8px rgba(0,0,0,0.12);
}
.member-social-icon:hover {
    background: rgba(255, 255, 255, 0.3);
    transform: translateY(-3px);
    box-shadow: 0 6px 14px rgba(0,0,0,0.2);
    color: #ffffff !important;
}
.member-social-icon i {
    font-size: 0.8rem;
}
.member-card-placeholder {
    width: 100%;
    height: 100%;
    background: linear-gradient(135deg, var(--primary) 0%, var(--primary-light) 100%);
    display: flex;
    align-items: center;
    justify-content: center;
    font-size: 3.5rem;
    font-weight: 700;
    color: rgba(255, 255, 255, 0.9);
    text-transform: uppercase;
}
.team-filters .form-control,
.team-filters .form-select { border-radius: 10px; transition: box-shadow 0.2s ease, border-color 0.2s ease; }
.team-filters .form-control:focus,
.team-filters .form-select:focus { box-shadow: 0 0 0 3px rgba(11, 83, 69, 0.15); }
.team-filters .btn { border-radius: 10px; font-weight: 600; }
@media (max-width: 992px) {
    .team-hero-title { font-size: calc(var(--team-title-size) * 0.85); }
    .team-hero-subtitle { font-size: calc(var(--team-subtitle-size) * 0.92); }
    .member-card-modern { min-height: calc(var(--team-card-min-h) * 0.95); max-height: calc(var(--team-card-max-h) * 0.95); }
    .member-card-content { min-height: 172px; padding: 18px 20px 4px 20px; margin-bottom: 0; }
}
@media (max-width: 768px) {
    .member-card-modern {
        min-height: calc(var(--team-card-min-h) * 0.9);
        max-height: calc(var(--team-card-max-h) * 0.9);
        border-radius: 16px;
    }
    .member-card-content {
        min-height: 168px;
        padding: 18px 20px 4px 20px;
        margin-bottom: 0;
    }
    .member-card-name { font-size: calc(var(--team-name-size) * 0.9); }
    .member-card-role { font-size: calc(var(--team-role-size) * 0.92); }
    .member-card-social { opacity: 1; transform: translateY(0); }
    .member-card-placeholder { font-size: 3rem; }
}
</style>
{% endblock %}

{% block content %}
<section class="py-5 team-page-section team-page-{{ team_settings.theme_mode|default:'light' }} team-cards-shadow-{{ team_settings.card_shadow|default:'medium' }} team-cards-hover-{{ team_settings.card_hover_effect|default:'lift' }} team-card-anim-{{ team_settings.card_animation|default:'none' }}" style="background: {% if team_settings.theme_mode == 'dark' %}#1e293b{% else %}var(--bg-warm){% endif %};" data-title-animation="{{ team_settings.title_animation|default:'typing' }}" data-typing-enabled="{{ team_settings.typing_enabled|yesno:'1,0' }}" data-typing-speed="{{ team_settings.typing_speed_ms }}">
    <div class="container team-page-wrap">
        {% if team_settings.background_watermark %}
        <div class="team-watermark" style="background-image: url('{{ team_settings.background_watermark.url }}');" aria-hidden="true"></div>
        {% endif %}

        <h1 class="team-hero-title mb-2 team-anim-{{ team_settings.title_animation|default:'typing' }}" id="team-title" data-title="{{ team_settings.title_text|escape }}" aria-live="polite"></h1>
        <p class="team-hero-subtitle mb-4" id="team-subtitle-wrap"
           data-count="{{ member_count }}"
           data-subtitle-template="{{ team_settings.subtitle_template|escape }}"
           data-title-animation="{{ team_settings.title_animation|default:'typing' }}"
           data-typing-enabled="{{ team_settings.typing_enabled|yesno:'1,0' }}"
           data-typing-speed="{{ team_settings.typing_speed_ms }}"
           aria-live="polite">
            <span id="team-subtitle"></span><span class="typed-cursor" id="team-cursor" aria-hidden="true"></span>
        </p>

        <!-- Top bar: Search (expandable) + Join Us only -->
        <div class="d-flex flex-wrap justify-content-end align-items-center gap-2 mb-4 team-top-actions">
            {% if team_settings.show_search %}
            <div class="team-search-wrap position-relative">
                <button type="button" class="btn btn-icon btn-search-toggle rounded-pill shadow-sm" id="team-search-toggle" aria-label="Search members" title="Search">
                    <i class="fas fa-search"></i>
                </button>
                <div class="team-search-expand rounded-pill shadow-sm" id="team-search-expand" aria-hidden="true">
                    <input type="text" class="form-control form-control-sm border-0 rounded-pill" id="team-search-input" placeholder="Search name, role, ID..." autocomplete="off">
                    <button type="button" class="btn btn-link btn-sm p-0 text-muted team-search-close" id="team-search-close" aria-label="Close search"><i class="fas fa-times"></i></button>
                </div>
            </div>
            {% endif %}
            <a href="#join" class="btn btn-primary rounded-pill shadow-sm px-4">
                <i class="fas fa-user-plus me-2"></i>Join Us
            </a>
        </div>

        <!-- Board Members – location tabs + AJAX cards -->
        <div class="mb-5 board-section" style="margin-bottom: var(--team-section-spacing);">
            <h2 class="h4 mb-2">Board Members</h2>
            <hr class="team-category-line" style="
                {% if team_settings.board_line_style == 'gradient' %}
                    height: {{ team_settings.board_line_thickness_px }}px;
                    background: linear-gradient(90deg, transparent 0%, {{ team_settings.board_line_color }} 18%, {{ team_settings.board_line_color_2 }} 50%, {{ team_settings.board_line_color }} 82%, transparent 100%);
                {% else %}
                    height: 0;
                    background: transparent;
                    border-top: {{ team_settings.board_line_thickness_px }}px {{ team_settings.board_line_style }} {{ team_settings.board_line_color }};
                {% endif %}
                width: {% if team_settings.board_line_full_width %}100%{% else %}{{ team_settings.board_line_length_percent }}%{% endif %};
                margin-left: {% if team_settings.board_line_full_width %}0{% else %}auto{% endif %};
                margin-right: {% if team_settings.board_line_full_width %}0{% else %}auto{% endif %};
            ">
            <div class="team-location-tabs-wrap">
                <nav class="team-location-tabs board-location-tabs" role="tablist" aria-label="Filter board members by chapter">
                    <button type="button" class="team-location-tab {% if not chapter_filter %}active{% endif %}" data-chapter="" aria-selected="{% if not chapter_filter %}true{% else %}false{% endif %}">All Members</button>
                    {% for ch in chapters %}
                    <button type="button" class="team-location-tab {% if chapter_filter == ch.id|stringformat:'d' %}active{% endif %}" data-chapter="{{ ch.id }}" aria-selected="{% if chapter_filter == ch.id|stringformat:'d' %}true{% else %}false{% endif %}">{{ ch.name }}</button>
                    {% endfor %}
                    <div class="team-location-indicator" aria-hidden="true"></div>
                </nav>
                <hr class="team-location-tabs-sep">
            </div>
            <div id="board-cards-container" class="volunteer-cards-transition">
                <div class="row g-4" id="board-cards-row">
                    {% for member in board_members %}
                    <div class="col-12 col-md-4 board-card-col">
                        <a href="{% url 'member_detail' member.pk %}" class="text-decoration-none">
                            <div class="member-card-modern">
                                {% if member.photo %}
                                <img src="{{ member.photo.url }}" alt="{{ member.name }}" class="member-card-image">
                                {% else %}
                                <div class="member-card-placeholder">{{ member.initials }}</div>
                                {% endif %}
                                <div class="member-card-overlay"></div>
                                <div class="member-card-content">
                                    <div class="member-card-name">{{ member.name }}</div>
                                    <div class="member-card-role">
                                        {% if member.role %}Board Member · {{ member.role }}{% else %}Board Member{% endif %}
                                    </div>
                                    {% if member.member_id %}
                                    <div class="member-card-id-wrap"><span class="member-card-id">{{ member.member_id }}</span></div>
                                    {% endif %}
                                    {% if member.location %}
                                    <div class="member-card-location small text-white-50 mt-1">{{ member.location_display }}</div>
                                    {% endif %}
                                    <div class="member-card-social">
                                        {% if member.facebook_url %}<a href="{{ member.facebook_url }}" target="_blank" rel="noopener" class="member-social-icon" title="Facebook"><i class="fab fa-facebook-f"></i></a>{% endif %}
                                        {% if member.instagram_url %}<a href="{{ member.instagram_url }}" target="_blank" rel="noopener" class="member-social-icon" title="Instagram"><i class="fab fa-instagram"></i></a>{% endif %}
                                        {% if member.linkedin_url %}<a href="{{ member.linkedin_url }}" target="_blank" rel="noopener" class="member-social-icon" title="LinkedIn"><i class="fab fa-linkedin-in"></i></a>{% endif %}
                                        {% if member.email %}<a href="mailto:{{ member.email }}" class="member-social-icon" title="Email"><i class="fas fa-envelope"></i></a>{% endif %}
                                    </div>
                                </div>
                            </div>
                        </a>
                    </div>
                    {% empty %}
                    <div class="col-12 text-center text-muted py-5">
                        <i class="fas fa-user-tie fa-3x mb-3 opacity-50"></i>
                        <p class="mb-0">No board members.</p>
                    </div>
                    {% endfor %}
                </div>
            </div>
        </div>

        <!-- Volunteers – three cards per row -->
        <div class="{% if board_members %}mt-5{% endif %} volunteer-section" style="margin-top: var(--team-section-spacing);">
            <h2 class="h4 mb-2">Volunteers</h2>
            <hr class="team-category-line" style="
                {% if team_settings.volunteer_line_style == 'gradient' %}
                    height: {{ team_settings.volunteer_line_thickness_px }}px;
                    background: linear-gradient(90deg, transparent 0%, {{ team_settings.volunteer_line_color }} 18%, {{ team_settings.volunteer_line_color_2 }} 50%, {{ team_settings.volunteer_line_color }} 82%, transparent 100%);
                {% else %}
                    height: 0;
                    background: transparent;
                    border-top: {{ team_settings.volunteer_line_thickness_px }}px {{ team_settings.volunteer_line_style }} {{ team_settings.volunteer_line_color }};
                {% endif %}
                width: {% if team_settings.volunteer_line_full_width %}100%{% else %}{{ team_settings.volunteer_line_length_percent }}%{% endif %};
                margin-left: {% if team_settings.volunteer_line_full_width %}0{% else %}auto{% endif %};
                margin-right: {% if team_settings.volunteer_line_full_width %}0{% else %}auto{% endif %};
            ">
            <div class="team-location-tabs-wrap">
                <nav class="team-location-tabs volunteer-location-tabs" role="tablist" aria-label="Filter volunteers by location">
                    <button type="button" class="team-location-tab {% if not location_filter %}active{% endif %}" data-location="" aria-selected="{% if not location_filter %}true{% else %}false{% endif %}">All Volunteers</button>
                    {% for loc_key, loc_label in location_choices %}
                    <button type="button" class="team-location-tab {% if location_filter == loc_key %}active{% endif %}" data-location="{{ loc_key }}" aria-selected="{% if location_filter == loc_key %}true{% else %}false{% endif %}">{{ loc_label }}</button>
                    {% endfor %}
                    <div class="team-location-indicator" aria-hidden="true"></div>
                </nav>
                <hr class="team-location-tabs-sep">
            </div>
            <div id="volunteer-cards-container" class="volunteer-cards-transition">
                <div class="row g-4" id="volunteer-cards-row">
                {% for member in volunteer_page_obj %}
                <div class="col-12 col-md-4">
                    <a href="{% url 'member_detail' member.pk %}" class="text-decoration-none">
                        <div class="member-card-modern">
                            {% if member.photo %}
                            <img src="{{ member.photo.url }}" alt="{{ member.name }}" class="member-card-image">
                            {% else %}
                            <div class="member-card-placeholder">{{ member.initials }}</div>
                            {% endif %}
                            <div class="member-card-overlay"></div>
                            <div class="member-card-content">
                                <div class="member-card-name">{{ member.name }}</div>
                                <div class="member-card-role">
                                    {% if member.role %}Volunteer{% if member.role != 'Volunteer' %} · {{ member.role }}{% endif %}{% else %}Volunteer{% endif %}
                                </div>
                                {% if member.member_id %}
                                <div class="member-card-id-wrap"><span class="member-card-id">{{ member.member_id }}</span></div>
                                {% endif %}
                                <div class="member-card-social">
                                    {% if member.facebook_url %}
                                <a href="{{ member.facebook_url }}" target="_blank" rel="noopener" class="member-social-icon" title="Facebook">
                                    <i class="fab fa-facebook-f"></i>
                                </a>
                                {% endif %}
                                {% if member.instagram_url %}
                                <a href="{{ member.instagram_url }}" target="_blank" rel="noopener" class="member-social-icon" title="Instagram">
                                    <i class="fab fa-instagram"></i>
                                </a>
                                {% endif %}
                                {% if member.linkedin_url %}
                                <a href="{{ member.linkedin_url }}" target="_blank" rel="noopener" class="member-social-icon" title="LinkedIn">
                                    <i class="fab fa-linkedin-in"></i>
                                </a>
                                {% endif %}
                                {% if member.email %}
                                <a href="mailto:{{ member.email }}" class="member-social-icon" title="Email">
                                    <i class="fas fa-envelope"></i>
                                </a>
                                {% endif %}
                                </div>
                            </div>
                        </div>
                    </a>
                </div>
                {% empty %}
                <div class="col-12 text-center text-muted py-5">
                    <i class="fas fa-users fa-3x mb-3 opacity-50"></i>
                    <p>No volunteers found.</p>
                </div>
                {% endfor %}
                </div>
            </div>
        </div>

        {% if volunteer_page_obj.paginator.num_pages > 1 %}
        <nav id="volunteer-pagination-nav" aria-label="Volunteers pagination" class="mt-4">
            <ul class="pagination justify-content-center">
                {% if volunteer_page_obj.has_previous %}
                <li class="page-item">
                    <a class="page-link" href="?{% for k,v in request.GET.items %}{% if k != 'page' %}{{ k }}={{ v|urlencode }}&{% endif %}{% endfor %}page={{ volunteer_page_obj.previous_page_number }}" aria-label="Previous">
                        <span aria-hidden="true">&laquo;</span>
                    </a>
                </li>
                {% else %}
                <li class="page-item disabled">
                    <span class="page-link" aria-hidden="true">&laquo;</span>
                </li>
                {% endif %}

                {% for p in volunteer_pagination_range %}
                    {% if p %}
                        <li class="page-item {% if p == volunteer_page_obj.number %}active{% endif %}">
                            <a class="page-link" href="?{% for k,v in request.GET.items %}{% if k != 'page' %}{{ k }}={{ v|urlencode }}&{% endif %}{% endfor %}page={{ p }}">{{ p }}</a>
                        </li>
                    {% else %}
                        <li class="page-item disabled"><span class="page-link">…</span></li>
                    {% endif %}
                {% endfor %}

                {% if volunteer_page_obj.has_next %}
                <li class="page-item">
                    <a class="page-link" href="?{% for k,v in request.GET.items %}{% if k != 'page' %}{{ k }}={{ v|urlencode }}&{% endif %}{% endfor %}page={{ volunteer_page_obj.next_page_number }}" aria-label="Next">
                        <span aria-hidden="true">&raquo;</span>
                    </a>
                </li>
                {% else %}
                <li class="page-item disabled">
                    <span class="page-link" aria-hidden="true">&raquo;</span>
                </li>
                {% endif %}
            </ul>
        </nav>
        {% endif %}

        <hr class="my-5" id="join">
        <!-- Join Us Section with Volunteer / Member toggle -->
        <div class="row mt-5 pt-5">
            <div class="col-lg-10 mx-auto">
                <div class="p-4 p-md-5 rounded-4" style="background: linear-gradient(135deg, rgba(11,83,69,0.08), rgba(193,127,89,0.08));">
                    <div class="mb-4">
                        <h2 class="section-title mb-1">Join Us</h2>
                        <p class="section-subtitle mb-0">Apply as a volunteer to support our mission.</p>
                    </div>

                    <div class="row g-4">
                        <div class="col-lg-6">
                            <div id="join-volunteer" class="join-panel">
                                <h5 class="mb-3">Volunteer Application</h5>
                                <p class="text-muted small mb-3">Share your time and skills. Profile image max 200 KB.</p>
                                <form method="post" action="{% url 'volunteer_form' %}" enctype="multipart/form-data" class="bg-white rounded-3 p-3 p-md-4 shadow-sm">
                                    {% csrf_token %}
                                    {{ volunteer_join_form|crispy }}
                                    <div class="d-flex justify-content-between align-items-center mt-3">
                                        <button type="submit" class="btn btn-primary">Submit Volunteer Application</button>
                                        <small class="text-muted d-none d-md-inline">You’ll be redirected after submitting.</small>
                                    </div>
                                </form>
                            </div>

                        </div>
                        <div class="col-lg-6 d-none d-lg-block">
                            <div class="h-100 d-flex align-items-center">
                                <div class="w-100 ps-lg-4">
                                    <div class="stat-card alt mb-3">
                                        <div class="d-flex justify-content-between align-items-center">
                                            <div>
                                                <h4 class="mb-1">Make an impact</h4>
                                                <p class="mb-0 small">Your time and membership help us reach more communities with health programs, education, and support.</p>
                                            </div>
                                            <i class="fas fa-hand-holding-heart fa-2x stat-icon"></i>
                                        </div>
                                    </div>
                                    <ul class="list-unstyled small mb-0">
                                        <li class="mb-2"><i class="fas fa-check-circle text-success me-2"></i>Transparent, CMS-managed membership fees</li>
                                        <li class="mb-2"><i class="fas fa-check-circle text-success me-2"></i>Secure payment via eSewa, Khalti, or Bank</li>
                                        <li class="mb-2"><i class="fas fa-check-circle text-success me-2"></i>Volunteer opportunities tailored to your skills</li>
                                        <li><i class="fas fa-check-circle text-success me-2"></i>Responsive design that works on any device</li>
                                    </ul>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</section>

{% block extra_js %}
{{ block.super }}
<script>
(function() {
    // Typing animation – heading and subtitle (slow, friendly)
    var titleEl = document.getElementById('team-title');
    var subtitleEl = document.getElementById('team-subtitle');
    var cursorEl = document.getElementById('team-cursor');
    var wrapEl = document.getElementById('team-subtitle-wrap');
    if (titleEl && subtitleEl && cursorEl && wrapEl) {
        var count = wrapEl.getAttribute('data-count') || '0';
        var titleText = titleEl.getAttribute('data-title') || 'Our Team';
        var subtitleTemplate = wrapEl.getAttribute('data-subtitle-template') || '';
        var titleAnimation = wrapEl.getAttribute('data-title-animation') || 'typing';
        var typingEnabled = (wrapEl.getAttribute('data-typing-enabled') || '1') === '1';
        var speed = parseInt(wrapEl.getAttribute('data-typing-speed') || '90', 10);
        if (!speed || speed < 20) speed = 90;
        var pauseBetween = 500;
        var subtitleFull = (subtitleTemplate || '').replace('{count}', count);

        function boldFirstCount(text, countStr) {
            var idx = text.indexOf(countStr);
            if (idx === -1) return text;
            return text.slice(0, idx) + '<strong>' + countStr + '</strong>' + text.slice(idx + countStr.length);
        }

        var typingRunId = 0;
        function typeChar(runId, el, text, i, cb) {
            if (runId !== typingRunId) return;
            if (i >= text.length) {
                if (cb) setTimeout(function() { if (runId === typingRunId) cb(); }, pauseBetween);
                return;
            }
            el.textContent = text.slice(0, i + 1);
            setTimeout(function() { typeChar(runId, el, text, i + 1, cb); }, speed);
        }

        function runSequence() {
            typingRunId += 1;
            var runId = typingRunId;
            titleEl.textContent = '';
            subtitleEl.textContent = '';
            var useTyping = (titleAnimation === 'typing' && typingEnabled);
            if (!useTyping) {
                cursorEl.style.display = 'none';
                titleEl.textContent = titleText;
                subtitleEl.innerHTML = boldFirstCount(subtitleFull, count);
                return;
            }
            cursorEl.style.display = 'inline-block';
            typeChar(runId, titleEl, titleText, 0, function() {
                if (runId !== typingRunId) return;
                typeChar(runId, subtitleEl, subtitleFull, 0, function() {
                    if (runId !== typingRunId) return;
                    subtitleEl.innerHTML = boldFirstCount(subtitleFull, count);
                    cursorEl.style.display = 'none';
                });
            });
        }
        runSequence();
    }

    // Board = chapter tabs; Volunteers = location tabs; sliding indicator per section
    var boardFilterUrl = "{% url 'team_board_filter' %}";
    var volunteerFilterUrl = "{% url 'team_volunteer_filter' %}";
    var currentBoardChapter = "{{ chapter_filter|escapejs }}";
    var currentVolunteerLocation = "{{ location_filter|escapejs }}";
    var searchQuery = '';

    function setIndicatorPosition(indicator, tab) {
        if (!indicator || !tab) return;
        var nav = indicator.closest('.team-location-tabs');
        if (!nav) return;
        var navRect = nav.getBoundingClientRect();
        var tabRect = tab.getBoundingClientRect();
        indicator.style.left = (tabRect.left - navRect.left) + 'px';
        indicator.style.width = tabRect.width + 'px';
    }

    function setupBoardTabs() {
        var nav = document.querySelector('.board-location-tabs');
        if (!nav) return;
        var tabs = nav.querySelectorAll('.team-location-tab');
        var indicator = nav.querySelector('.team-location-indicator');
        var row = document.getElementById('board-cards-row');
        var container = document.getElementById('board-cards-container');

        function setActive(activeTab) {
            tabs.forEach(function(t) { t.classList.remove('active'); t.setAttribute('aria-selected', 'false'); });
            if (activeTab) { activeTab.classList.add('active'); activeTab.setAttribute('aria-selected', 'true'); setIndicatorPosition(indicator, activeTab); }
        }
        var activeTab = nav.querySelector('.team-location-tab.active');
        if (activeTab && indicator) setIndicatorPosition(indicator, activeTab);

        tabs.forEach(function(tab) {
            tab.addEventListener('click', function() {
                if (tab.classList.contains('active')) return;
                setActive(tab);
                currentBoardChapter = tab.getAttribute('data-chapter') || '';
                if (container) container.classList.add('is-loading');
                var params = new URLSearchParams();
                if (currentBoardChapter) params.set('chapter', currentBoardChapter);
                if (searchQuery) params.set('search', searchQuery);
                var url = boardFilterUrl + (params.toString() ? '?' + params.toString() : '');
                fetch(url, { headers: { 'X-Requested-With': 'XMLHttpRequest' } }).then(function(r) { return r.text(); })
                    .then(function(html) { row.innerHTML = html; if (container) container.classList.remove('is-loading'); })
                    .catch(function() { if (container) container.classList.remove('is-loading'); });
            });
        });
        window.addEventListener('resize', function() {
            var active = nav.querySelector('.team-location-tab.active');
            if (active && indicator) setIndicatorPosition(indicator, active);
        });
    }

    function setupVolunteerTabs() {
        var nav = document.querySelector('.volunteer-location-tabs');
        if (!nav) return;
        var tabs = nav.querySelectorAll('.team-location-tab');
        var indicator = nav.querySelector('.team-location-indicator');
        var row = document.getElementById('volunteer-cards-row');
        var container = document.getElementById('volunteer-cards-container');
        var paginationNav = document.getElementById('volunteer-pagination-nav');

        function setActive(activeTab) {
            tabs.forEach(function(t) { t.classList.remove('active'); t.setAttribute('aria-selected', 'false'); });
            if (activeTab) { activeTab.classList.add('active'); activeTab.setAttribute('aria-selected', 'true'); setIndicatorPosition(indicator, activeTab); }
        }
        var activeTab = nav.querySelector('.team-location-tab.active');
        if (activeTab && indicator) setIndicatorPosition(indicator, activeTab);

        tabs.forEach(function(tab) {
            tab.addEventListener('click', function() {
                if (tab.classList.contains('active')) return;
                setActive(tab);
                currentVolunteerLocation = tab.getAttribute('data-location') || '';
                if (container) container.classList.add('is-loading');
                if (paginationNav) paginationNav.style.display = 'none';
                var params = new URLSearchParams();
                if (currentVolunteerLocation) params.set('location', currentVolunteerLocation);
                if (searchQuery) params.set('search', searchQuery);
                var url = volunteerFilterUrl + (params.toString() ? '?' + params.toString() : '');
                fetch(url, { headers: { 'X-Requested-With': 'XMLHttpRequest' } }).then(function(r) { return r.text(); })
                    .then(function(html) { row.innerHTML = html; if (container) container.classList.remove('is-loading'); })
                    .catch(function() { if (container) container.classList.remove('is-loading'); });
            });
        });
        window.addEventListener('resize', function() {
            var active = nav.querySelector('.team-location-tab.active');
            if (active && indicator) setIndicatorPosition(indicator, active);
        });
    }

    setupBoardTabs();
    setupVolunteerTabs();

    function fetchBothSections() {
        var boardRow = document.getElementById('board-cards-row');
        var volunteerRow = document.getElementById('volunteer-cards-row');
        var boardContainer = document.getElementById('board-cards-container');
        var volunteerContainer = document.getElementById('volunteer-cards-container');
        var paginationNav = document.getElementById('volunteer-pagination-nav');
        if (!boardRow || !volunteerRow) return;
        if (boardContainer) boardContainer.classList.add('is-loading');
        if (volunteerContainer) volunteerContainer.classList.add('is-loading');
        if (paginationNav) paginationNav.style.display = 'none';

        var boardParams = new URLSearchParams();
        if (currentBoardChapter) boardParams.set('chapter', currentBoardChapter);
        if (searchQuery) boardParams.set('search', searchQuery);
        var volParams = new URLSearchParams();
        if (currentVolunteerLocation) volParams.set('location', currentVolunteerLocation);
        if (searchQuery) volParams.set('search', searchQuery);

        Promise.all([
            fetch(boardFilterUrl + (boardParams.toString() ? '?' + boardParams.toString() : ''), { headers: { 'X-Requested-With': 'XMLHttpRequest' } }).then(function(r) { return r.text(); }),
            fetch(volunteerFilterUrl + (volParams.toString() ? '?' + volParams.toString() : ''), { headers: { 'X-Requested-With': 'XMLHttpRequest' } }).then(function(r) { return r.text(); })
        ]).then(function(htmls) {
            boardRow.innerHTML = htmls[0];
            volunteerRow.innerHTML = htmls[1];
            if (boardContainer) boardContainer.classList.remove('is-loading');
            if (volunteerContainer) volunteerContainer.classList.remove('is-loading');
        }).catch(function() {
            if (boardContainer) boardContainer.classList.remove('is-loading');
            if (volunteerContainer) volunteerContainer.classList.remove('is-loading');
        });
    }

    var searchDebounce;
    var searchInput = document.getElementById('team-search-input');
    if (searchInput) {
        searchInput.addEventListener('input', function() {
            searchQuery = this.value.trim();
            clearTimeout(searchDebounce);
            searchDebounce = setTimeout(fetchBothSections, 280);
        });
    }

    var searchToggle = document.getElementById('team-search-toggle');
    var searchExpand = document.getElementById('team-search-expand');
    var searchClose = document.getElementById('team-search-close');
    if (searchToggle && searchExpand) {
        searchToggle.addEventListener('click', function() {
            searchExpand.classList.add('is-open');
            searchExpand.setAttribute('aria-hidden', 'false');
            searchInput && searchInput.focus();
        });
    }
    if (searchClose && searchExpand) {
        searchClose.addEventListener('click', function() {
            searchExpand.classList.remove('is-open');
            searchExpand.setAttribute('aria-hidden', 'true');
            if (searchInput) { searchInput.value = ''; searchQuery = ''; fetchBothSections(); }
        });
    }
})();
</script>
{% endblock %}
{% endblock %}
